<!DOCTYPE html>
<html>
<head>
  <title>Adventure Planner</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>

<div class="planner-layout">

  <div id="map"></div>

  <div id="sidebar">
    <h3>Route Info</h3>
    <div id="routeInfo" class="route-info">Total Distance: â€“</div>

    <div class="planner-actions">
      <label for="routeNameInput">Route Name</label>
      <input id="routeNameInput" type="text" placeholder="e.g. Sunday Mountain Loop">
      <button class="secondary-btn" onclick="saveRoute()">Save Route</button>
      <button class="secondary-btn" onclick="loadLatestRoute()">Load Latest</button>
      <p id="plannerMessage" class="status-message"></p>
    </div>

    <h3>Waypoints</h3>
    <div id="waypointList"></div>
  </div>

</div>

<div id="floatingDirections" class="floating-directions collapsed">
  <div class="floating-header" onclick="toggleDirections()">
    Directions <span id="dirArrow">â–²</span>
  </div>
  <div class="floating-content">
    <div id="directionsList">No route yet.</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
var map = L.map('map').setView([48.2, 14.3], 10);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

var waypoints = [];
var waypointCounter = 1;
var segmentLayers = [];

function setMessage(text) {
  document.getElementById('plannerMessage').textContent = text;
}

function currentRouteName() {
  return document.getElementById('routeNameInput').value.trim();
}

function safeText(value) {
  return String(value || '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

async function checkSession() {
  const res = await fetch('/api/session');
  const data = await res.json();
  if (!data.loggedIn) {
    window.location.href = 'index.html';
    return false;
  }
  return true;
}

map.on('click', function(e) {
  waypoints.push({
    latlng: e.latlng,
    name: 'Waypoint ' + waypointCounter,
    links: [],
    notes: []
  });

  waypointCounter++;
  renderSidebar();
  updateRouting();
});

function createRouteControl(wp1, wp2, mode) {
  const modeConfig = mode === 'hike'
    ? {
      serviceUrl: 'https://routing.openstreetmap.de/routed-foot/route/v1',
      color: '#2ecc71'
    }
    : {
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      color: '#e74c3c'
    };

  return L.Routing.control({
    waypoints: [wp1.latlng, wp2.latlng],
    router: L.Routing.osrmv1({ serviceUrl: modeConfig.serviceUrl }),
    addWaypoints: false,
    draggableWaypoints: false,
    show: false,
    createMarker: function() { return null; },
    lineOptions: { styles: [{ color: modeConfig.color, weight: 4 }] }
  }).addTo(map);
}

function updateRouting() {
  segmentLayers.forEach((layer) => {
    if (layer instanceof L.Routing.Control) {
      layer.remove();
    } else {
      map.removeLayer(layer);
    }
  });

  segmentLayers = [];
  let totalDistance = 0;
  let allInstructions = [];
  let pendingSegments = 0;

  if (waypoints.length < 2) {
    document.getElementById('routeInfo').innerHTML = 'Total Distance: â€“';
    document.getElementById('directionsList').innerHTML = 'No route yet.';
    return;
  }

  for (let i = 0; i < waypoints.length - 1; i++) {
    const wp1 = waypoints[i];
    const wp2 = waypoints[i + 1];
    const select = document.getElementById('segmentMode_' + i);
    const mode = select ? select.value : 'road';

    pendingSegments++;
    const control = createRouteControl(wp1, wp2, mode);
    segmentLayers.push(control);

    control.on('routesfound', function(e) {
      const route = e.routes[0];
      totalDistance += route.summary.totalDistance;
      allInstructions = allInstructions.concat(route.instructions);
      pendingSegments--;

      if (pendingSegments === 0) {
        updateRouteInfo(totalDistance);
        renderDirections(allInstructions);
      }
    });

    control.on('routingerror', function() {
      const fallback = L.polyline([wp1.latlng, wp2.latlng], {
        color: '#f39c12',
        weight: 4,
        dashArray: '6,6'
      }).addTo(map);
      segmentLayers.push(fallback);

      const dist = wp1.latlng.distanceTo(wp2.latlng);
      totalDistance += dist;
      allInstructions.push({ text: `Fallback direct segment (${mode})`, distance: dist });
      pendingSegments--;

      if (pendingSegments === 0) {
        updateRouteInfo(totalDistance);
        renderDirections(allInstructions);
      }
    });
  }
}

function updateRouteInfo(distanceMeters) {
  document.getElementById('routeInfo').innerHTML = 'Total Distance: ' + (distanceMeters / 1000).toFixed(2) + ' km';
}

function renderSidebar() {
  const container = document.getElementById('waypointList');
  container.innerHTML = '';

  waypoints.forEach((wp, index) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'wp-item';

    let segmentControl = '';
    if (index < waypoints.length - 1) {
      segmentControl =
        "<select class='segment-select' id='segmentMode_" + index + "' onchange='updateRouting()'>" +
        "<option value='road'>ðŸš— Road</option>" +
        "<option value='hike'>ðŸ¥¾ Hiking Path</option>" +
        '</select>';
    }

    const linksHtml = (wp.links || []).map((link, linkIndex) =>
      "<div class='array-row'>" +
      "<input value='" + safeText(link) + "' placeholder='https://...' onchange='editLink(" + index + ", " + linkIndex + ", this.value)'/>" +
      "<button type='button' class='tiny-btn' onclick='removeLink(" + index + ", " + linkIndex + ")'>âœ•</button>" +
      '</div>'
    ).join('');

    const notesHtml = (wp.notes || []).map((note, noteIndex) =>
      "<div class='array-row'>" +
      "<textarea rows='2' onchange='editNote(" + index + ", " + noteIndex + ", this.value)'>" + safeText(note) + '</textarea>' +
      "<button type='button' class='tiny-btn' onclick='removeNote(" + index + ", " + noteIndex + ")'>âœ•</button>" +
      '</div>'
    ).join('');

    wrapper.innerHTML =
      "<div class='wp-header' onclick='toggleWaypoint(" + index + ")'>" +
      '<span>' + safeText(wp.name) + '</span>' +
      segmentControl +
      '</div>' +
      "<div class='wp-content'>" +
      '<label>Name:</label>' +
      "<input value='" + safeText(wp.name) + "' onchange='editName(" + index + ", this.value)' /><br>" +
      '<label>Links:</label>' +
      "<div class='array-list'>" + linksHtml + '</div>' +
      "<button type='button' class='tiny-add-btn' onclick='addLink(" + index + ")'>+ Add Link</button>" +
      '<label>Notes:</label>' +
      "<div class='array-list'>" + notesHtml + '</div>' +
      "<button type='button' class='tiny-add-btn' onclick='addNote(" + index + ")'>+ Add Note</button>" +
      '</div>';

    container.appendChild(wrapper);
  });
}

function toggleWaypoint(index) {
  document.querySelectorAll('.wp-item')[index].classList.toggle('expanded');
}

function editName(index, value) {
  waypoints[index].name = value;
  renderSidebar();
}

function addLink(index) {
  waypoints[index].links = waypoints[index].links || [];
  waypoints[index].links.push('');
  renderSidebar();
}

function editLink(index, linkIndex, value) {
  waypoints[index].links[linkIndex] = value;
}

function removeLink(index, linkIndex) {
  waypoints[index].links.splice(linkIndex, 1);
  renderSidebar();
}

function addNote(index) {
  waypoints[index].notes = waypoints[index].notes || [];
  waypoints[index].notes.push('');
  renderSidebar();
}

function editNote(index, noteIndex, value) {
  waypoints[index].notes[noteIndex] = value;
}

function removeNote(index, noteIndex) {
  waypoints[index].notes.splice(noteIndex, 1);
  renderSidebar();
}

function renderDirections(instructions) {
  const container = document.getElementById('directionsList');
  container.innerHTML = '';

  instructions.forEach((step) => {
    const div = document.createElement('div');
    div.className = 'direction-step';
    div.innerHTML = '<div>' + safeText(step.text) + '</div>' + '<small>' + (step.distance / 1000).toFixed(2) + ' km</small>';
    container.appendChild(div);
  });
}

function toggleDirections() {
  const panel = document.getElementById('floatingDirections');
  const arrow = document.getElementById('dirArrow');
  panel.classList.toggle('collapsed');
  arrow.textContent = panel.classList.contains('collapsed') ? 'â–²' : 'â–¼';
}

function serializeWaypoints() {
  return waypoints.map((wp) => ({
    lat: wp.latlng.lat,
    lng: wp.latlng.lng,
    name: wp.name,
    links: (wp.links || []).map((value) => String(value || '').trim()).filter(Boolean),
    notes: (wp.notes || []).map((value) => String(value || '').trim()).filter(Boolean)
  }));
}

function loadWaypoints(saved) {
  waypoints = (saved || []).map((wp, index) => ({
    latlng: L.latLng(wp.lat, wp.lng),
    name: wp.name || `Waypoint ${index + 1}`,
    links: Array.isArray(wp.links) ? wp.links : (wp.url ? [wp.url] : []),
    notes: Array.isArray(wp.notes) ? wp.notes : (wp.notes ? [wp.notes] : [])
  }));

  waypointCounter = waypoints.length + 1;
  renderSidebar();
  updateRouting();
}

async function saveRoute() {
  if (waypoints.length < 2) {
    setMessage('Add at least 2 waypoints to save.');
    return;
  }

  const routeName = currentRouteName();
  if (!routeName) {
    setMessage('Please enter a route name.');
    return;
  }

  const res = await fetch('/api/routes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ waypoints: serializeWaypoints(), name: routeName })
  });

  const data = await res.json();
  if (!res.ok) {
    setMessage(data.error || 'Unable to save route.');
    return;
  }

  document.getElementById('routeNameInput').value = data.route.name;
  setMessage(`Saved: ${data.route.name}`);
}

async function loadLatestRoute() {
  const res = await fetch('/api/routes/latest');
  const data = await res.json();

  if (!res.ok) {
    setMessage(data.error || 'Unable to load route.');
    return;
  }

  if (!data.route) {
    setMessage('No saved route found yet.');
    return;
  }

  document.getElementById('routeNameInput').value = data.route.name || '';
  loadWaypoints(data.route.waypoints);
  setMessage(`Loaded: ${data.route.name}`);
}

async function loadRouteFromQuery() {
  const routeId = new URLSearchParams(window.location.search).get('routeId');
  if (!routeId) return;

  const res = await fetch(`/api/routes/${routeId}`);
  const data = await res.json();

  if (!res.ok) {
    setMessage(data.error || 'Unable to load selected route.');
    return;
  }

  document.getElementById('routeNameInput').value = data.route.name || '';
  loadWaypoints(data.route.waypoints);
  setMessage(`Loaded: ${data.route.name}`);
}

(async function init() {
  const loggedIn = await checkSession();
  if (!loggedIn) return;
  await loadRouteFromQuery();
})();
</script>

</body>
</html>
